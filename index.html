<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balady & RIPC User Status Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="p-6">
        <div class="max-w-7xl mx-auto" id="tracker-content">
            <!-- Top Button Section -->
            <div class="bg-white rounded-lg shadow-xl p-6 mb-6 main-header">
                <div class="flex justify-end items-start">
                    <div class="flex gap-3 action-buttons">
                        <button onclick="updateAndSave('balady')" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                            Update
                        </button>
                        <button onclick="exportToCSV('balady')" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Export CSV
                        </button>
                        <button onclick="takeScreenshot('both')" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            Get Both SS
                        </button>
                        <button onclick="takeScreenshot('balady')" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            Balady SS
                        </button>
                        <button onclick="takeScreenshot('ripc')" class="flex items-center gap-2 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            RIPC SS
                        </button>
                    </div>
                </div>
            </div>

            <!-- Balady Section -->
            <div class="mb-8" id="balady-section">
                <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                    <h2 class="text-3xl font-bold text-blue-900 mb-2">Balady User Update [Evening Shift]</h2>
                    <div class="text-sm text-gray-600">
                        <p><strong>Auto-Update Logic:</strong> "Working" users show current date (<span id="current-date-balady"></span>), "Not Working" users keep their last working date.</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-green-50 rounded-lg p-4 border-2 border-green-200 flex flex-col items-center justify-center">
                            <p class="text-3xl font-bold text-green-700" id="balady-working-count">0</p>
                            <p class="text-sm text-gray-600 font-semibold">Working</p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 border-2 border-red-200 flex flex-col items-center justify-center">
                            <p class="text-3xl font-bold text-red-700" id="balady-not-working-count">0</p>
                            <p class="text-sm text-gray-600 font-semibold">Not Working</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-200 flex flex-col items-center justify-center">
                            <p class="text-3xl font-bold text-blue-700" id="balady-total-count">0</p>
                            <p class="text-sm text-gray-600 font-semibold">Total Users</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse" style="min-width: 1150px" id="balady-table">
                            <thead class="bg-blue-900 text-white">
                                <tr>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 50px">Sr</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 120px">Balady User</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 140px">Contact</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 120px">District</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 110px">RPA Status</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 100px"># of Restarts</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 120px">RPA Restarted?</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 160px">Reason</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 130px">Last Working Date</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold action-column" style="width: 100px">Action</th>
                                </tr>
                            </thead>
                            <tbody id="balady-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RIPC Section -->
            <div class="mb-8" id="ripc-section">
                <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                    <h2 class="text-3xl font-bold text-blue-900 mb-2">RIPC User Update [Evening Shift]</h2>
                    <div class="text-sm text-gray-600">
                        <p><strong>Auto-Update Logic:</strong> "Working" users show current date (<span id="current-date-ripc"></span>), "Not Working" users keep their last working date.</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse" style="min-width: 1150px" id="ripc-table">
                            <thead class="bg-blue-900 text-white">
                                <tr>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 50px">Sr</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 120px">RIPC User</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 140px">Contact</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 120px">District</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 110px">RPA Status</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 100px"># of Restarts</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 120px">RPA Restarted?</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 160px">Reason</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold" style="width: 130px">Last Working Date</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold action-column" style="width: 100px">Action</th>
                                </tr>
                            </thead>
                            <tbody id="ripc-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        // Initial data
        const initialBaladyUsers = [
            { id: 1, name: "Hussam", contact: "+966 55 498 7925", district: "Najran", status: "Not Working", restarts: 0, restarted: "No", reason: "Waiting for OTP", lastWorking: "12/17/2025" },
            { id: 2, name: "Adel", contact: "+966 54 717 4763", district: "Abha", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 3, name: "Sajjad", contact: "+966 59 272 6929", district: "Qassim", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 4, name: "Zuabi", contact: "+966 55 898 9569", district: "Jizan", status: "Not Working", restarts: 0, restarted: "No", reason: "Waiting for OTP", lastWorking: "12/17/2025" },
            { id: 5, name: "Alwan", contact: "+966 53 754 6944", district: "Jeddah", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 6, name: "Yaser", contact: "+966 55 022 2717", district: "Jizan", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 7, name: "Sultan", contact: "+966 53 131 3677", district: "Dammam", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 8, name: "Abdullah", contact: "+966 50 333 8299", district: "Hofuf", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 9, name: "Radi", contact: "+966 55 511 3243", district: "Hafar Al Batin", status: "Not Working", restarts: 0, restarted: "No", reason: "Waiting for OTP", lastWorking: "12/16/2025" },
            { id: 10, name: "Basil", contact: "+966 58 062 3851", district: "Madinah", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 11, name: "Bilawal", contact: "+966 53 868 2527", district: "Baha", status: "Not Working", restarts: 0, restarted: "No", reason: "Waiting for OTP", lastWorking: "12/16/2025" },
            { id: 12, name: "Zowaid", contact: "+966 55 508 6028", district: "Makkah", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 13, name: "Abdulrahman", contact: "+966 53 246 1832", district: "Tabuk", status: "Not Working", restarts: 0, restarted: "No", reason: "Waiting for OTP", lastWorking: "12/18/2025" },
            { id: 14, name: "Abdulkarim", contact: "+966 56 522 1577", district: "Hail", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 15, name: "Fahad", contact: "+966 55 556 6948", district: "Taif", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 16, name: "Khalid", contact: "+966 54 751 3505", district: "Madinah", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 17, name: "Saud", contact: "+966 50 496 7156", district: "Sakaka", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/20/2025" },
            { id: 18, name: "Hassan", contact: "+966 50 211 0938", district: "Jubail/Khafji", status: "Not Working", restarts: 0, restarted: "No", reason: "Waiting for OTP", lastWorking: "12/14/2025" }
        ];

        const initialRipcUsers = [
            { id: 1, name: "Ubaid", contact: "+966 50 766 6822", district: "Riyadh", status: "Working", restarts: 1, restarted: "Yes", reason: "", lastWorking: "12/23/2025" }
        ];

        let baladyUsers = JSON.parse(localStorage.getItem('baladyUsers')) || initialBaladyUsers;
        let ripcUsers = JSON.parse(localStorage.getItem('ripcUsers')) || initialRipcUsers;

        function getCurrentDate() {
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const year = today.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function updateDateDisplays() {
            const currentDate = getCurrentDate();
            document.getElementById('current-date-balady').textContent = currentDate;
            document.getElementById('current-date-ripc').textContent = currentDate;
        }

        function saveData(userType) {
            const users = userType === 'balady' ? baladyUsers : ripcUsers;
            localStorage.setItem(userType === 'balady' ? 'baladyUsers' : 'ripcUsers', JSON.stringify(users));
        }

        function updateAndSave(userType) {
            const currentDate = getCurrentDate();
            const users = userType === 'balady' ? baladyUsers : ripcUsers;
            
            users.forEach(user => {
                if (user.status === "Working") {
                    user.lastWorking = currentDate;
                }
            });
            
            saveData(userType);
            renderTable(userType);
            alert(`${userType === 'balady' ? 'Balady' : 'RIPC'} data updated and saved successfully!`);
        }

        function toggleStatus(id, userType) {
            const currentDate = getCurrentDate();
            const users = userType === 'balady' ? baladyUsers : ripcUsers;
            
            const user = users.find(u => u.id === id);
            if (user) {
                const newStatus = user.status === "Working" ? "Not Working" : "Working";
                user.status = newStatus;
                user.lastWorking = newStatus === "Working" ? currentDate : user.lastWorking;
                user.restarts = newStatus === "Working" ? 1 : 0;
                user.restarted = newStatus === "Working" ? "Yes" : "No";
                user.reason = newStatus === "Not Working" ? "Waiting for OTP" : "";
            }
            
            saveData(userType);
            renderTable(userType);
        }

        function updateReason(id, reason, userType) {
            const users = userType === 'balady' ? baladyUsers : ripcUsers;
            const user = users.find(u => u.id === id);
            if (user) {
                user.reason = reason;
            }
            saveData(userType);
        }

        function updateLastWorking(id, lastWorking, userType) {
            const users = userType === 'balady' ? baladyUsers : ripcUsers;
            const user = users.find(u => u.id === id);
            if (user) {
                user.lastWorking = lastWorking;
            }
            saveData(userType);
        }

        function exportToCSV(userType) {
            const users = userType === 'balady' ? baladyUsers : ripcUsers;
            const label = userType === 'balady' ? 'Balady' : 'RIPC';
            
            const headers = ["Sr", `${label} User`, "Contact", "District", "RPA Status", "# of Restarts", "RPA Restarted?", "Reason", "Last Working Date"];
            const rows = users.map(user => [
                user.id,
                user.name,
                user.contact,
                user.district,
                user.status,
                user.restarts,
                user.restarted,
                user.reason,
                user.lastWorking
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${label.toLowerCase()}_status_${getCurrentDate().replace(/\//g, '_')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function takeScreenshot(section = 'both') {
            try {
                const element = document.getElementById('tracker-content');
                const clone = element.cloneNode(true);
                
                let usersToProcess = [];
                if (section === 'balady') {
                    usersToProcess = [...baladyUsers];
                } else if (section === 'ripc') {
                    usersToProcess = [...ripcUsers];
                } else {
                    usersToProcess = [...baladyUsers, ...ripcUsers];
                }
                
                if (section !== 'both') {
                    const mainHeader = clone.querySelector('.main-header');
                    if (mainHeader) mainHeader.remove();
                }
                
                if (section === 'balady') {
                    const ripcSection = clone.querySelector('#ripc-section');
                    if (ripcSection) ripcSection.remove();
                } else if (section === 'ripc') {
                    const baladySection = clone.querySelector('#balady-section');
                    if (baladySection) baladySection.remove();
                }
                
                const cloneButtons = clone.querySelectorAll('.action-buttons');
                cloneButtons.forEach(btn => btn.remove());
                
                const cloneActionHeaders = clone.querySelectorAll('.action-column');
                cloneActionHeaders.forEach(el => el.remove());
                
                const rows = clone.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 10) {
                        cells[9].remove();
                    }
                });
                
                const dateInputs = clone.querySelectorAll('input[type="text"]');
                dateInputs.forEach((input, index) => {
                    if (index < usersToProcess.length) {
                        const parentTd = input.closest('td');
                        const user = usersToProcess[index];
                        const span = document.createElement('span');
                        span.textContent = input.value;
                        const textColor = user.status === 'Not Working' ? '#b91c1c' : '#111827';
                        span.style.cssText = `display: block; width: 100%; text-align: center; font-size: 1rem; color: ${textColor}; font-weight: 500;`;
                        parentTd.innerHTML = '';
                        parentTd.appendChild(span);
                    }
                });
                
                const reasonRows = clone.querySelectorAll('tbody tr');
                reasonRows.forEach((row, index) => {
                    if (index < usersToProcess.length) {
                        const reasonTd = row.children[7];
                        const user = usersToProcess[index];
                        if (reasonTd) {
                            const span = document.createElement('span');
                            if (user.status === 'Not Working' && user.reason) {
                                span.textContent = user.reason;
                                span.style.cssText = 'display:block;text-align:center;padding:4px 8px;border-radius:4px;background:#fef2f2;font-size:1rem;color:#b91c1c;font-weight:500;';
                            } else {
                                span.textContent = '-';
                                span.style.cssText = 'display:block;text-align:center;font-size:1rem;color:#9ca3af;';
                            }
                            reasonTd.innerHTML = '';
                            reasonTd.appendChild(span);
                        }
                    }
                });

                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                clone.style.top = '0';
                clone.style.width = '1600px';
                clone.style.maxWidth = '1600px';
                clone.style.padding = '0';
                clone.style.margin = '0';
                clone.style.background = '#f0f4ff';
                
                document.body.appendChild(clone);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(clone, {
                    backgroundColor: '#f0f4ff',
                    scale: 2.5,
                    width: 1600,
                    windowWidth: 1600,
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });

                document.body.removeChild(clone);
                
                canvas.toBlob((blob) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const sectionName = section === 'both' ? 'tracker' : section;
                    a.download = `${sectionName}_${getCurrentDate().replace(/\//g, '_')}.png`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
            } catch (error) {
                console.error('Screenshot error:', error);
                alert('Error taking screenshot. Please try again.');
            }
        }

        function renderTable(userType) {
            const users = userType === 'balady' ? baladyUsers : ripcUsers;
            const tbody = document.getElementById(`${userType}-tbody`);
            const label = userType === 'balady' ? 'Balady' : 'RIPC';
            
            tbody.innerHTML = users.map(user => `
                <tr class="${user.status === 'Not Working' ? 'bg-red-50' : 'bg-white'} border-b hover:bg-gray-50 transition">
                    <td class="px-2 py-3 text-center ${user.status === 'Not Working' ? 'text-red-700' : 'text-gray-900'}" style="width: 50px; font-size: 1rem">${user.id}</td>
                    <td class="px-2 py-3 text-center font-medium ${user.status === 'Not Working' ? 'text-red-700' : 'text-gray-900'}" style="width: 120px; font-size: 1rem">${user.name}</td>
                    <td class="px-2 py-3 text-center ${user.status === 'Not Working' ? 'text-red-700' : 'text-blue-600'}" style="width: 140px; font-size: 1rem">${user.contact}</td>
                    <td class="px-2 py-3 text-center font-medium ${user.status === 'Not Working' ? 'text-red-700' : 'text-gray-700'}" style="width: 120px; font-size: 1rem">${user.district}</td>
                    <td class="px-2 py-3 text-center" style="width: 110px">
                        <span class="font-semibold ${user.status === 'Working' ? 'text-green-800' : 'text-red-700'}" style="font-size: 1rem">${user.status}</span>
                    </td>
                    <td class="px-2 py-3 text-center font-medium ${user.status === 'Not Working' ? 'text-red-700' : 'text-gray-900'}" style="width: 100px; font-size: 1rem">${user.restarts}</td>
                    <td class="px-2 py-3 text-center" style="width: 120px">
                        <span class="font-medium ${user.restarted === 'Yes' ? 'text-green-800' : 'text-red-700'}" style="font-size: 1rem">${user.restarted}</span>
                    </td>
                    <td class="px-2 py-3" style="width: 160px">
                        ${user.status === 'Not Working' ? `
                            <select onchange="updateReason(${user.id}, this.value, '${userType}')" class="w-full px-2 py-1 border border-gray-300 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer text-red-700 font-medium bg-red-50" style="font-size: 1rem">
                                <option value="" ${user.reason === '' ? 'selected' : ''}>Select Reason</option>
                                <option value="Waiting for OTP" ${user.reason === 'Waiting for OTP' ? 'selected' : ''}>Waiting for OTP</option>
                                <option value="OTP not received" ${user.reason === 'OTP not received' ? 'selected' : ''}>OTP not received</option>
                            </select>
                        ` : '<div class="text-center text-gray-400" style="font-size: 1rem">-</div>'}
                    </td>
                    <td class="px-2 py-3" style="width: 130px">
                        <input type
